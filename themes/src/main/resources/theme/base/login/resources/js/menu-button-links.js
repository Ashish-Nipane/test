/*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 *
 *   File:   menu-button-links.js
 *
 *   Desc:   Creates a menu button that opens a menu of links
 * 
 *   Modified: Peter Keuter. The original source file is transpiled to ES5 and minified
 */
function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}let MenuButtonLinks=function(){function e(t){_classCallCheck(this,e),this.domNode=t,this.buttonNode=t.querySelector("button"),this.menuNode=t.querySelector('[role="menu"]'),this.menuitemNodes=[],this.firstMenuitem=!1,this.lastMenuitem=!1,this.firstChars=[],this.buttonNode.addEventListener("keydown",this.onButtonKeydown.bind(this)),this.buttonNode.addEventListener("click",this.onButtonClick.bind(this));for(var s=t.querySelectorAll('[role="menuitem"]'),i=0;i<s.length;i++){var o=s[i];this.menuitemNodes.push(o),o.tabIndex=-1,this.firstChars.push(o.textContent.trim()[0].toLowerCase()),o.addEventListener("keydown",this.onMenuitemKeydown.bind(this)),o.addEventListener("mouseover",this.onMenuitemMouseover.bind(this)),this.firstMenuitem||(this.firstMenuitem=o),this.lastMenuitem=o}t.addEventListener("focusin",this.onFocusin.bind(this)),t.addEventListener("focusout",this.onFocusout.bind(this)),window.addEventListener("mousedown",this.onBackgroundMousedown.bind(this),!0)}return _createClass(e,[{key:"setFocusToMenuitem",value:function(e){this.menuitemNodes.forEach(function(t){t===e?(t.tabIndex=0,e.focus()):t.tabIndex=-1})}},{key:"setFocusToFirstMenuitem",value:function(){this.setFocusToMenuitem(this.firstMenuitem)}},{key:"setFocusToLastMenuitem",value:function(){this.setFocusToMenuitem(this.lastMenuitem)}},{key:"setFocusToPreviousMenuitem",value:function(e){var t,s;return e===this.firstMenuitem?t=this.lastMenuitem:(s=this.menuitemNodes.indexOf(e),t=this.menuitemNodes[s-1]),this.setFocusToMenuitem(t),t}},{key:"setFocusToNextMenuitem",value:function(e){var t,s;return e===this.lastMenuitem?t=this.firstMenuitem:(s=this.menuitemNodes.indexOf(e),t=this.menuitemNodes[s+1]),this.setFocusToMenuitem(t),t}},{key:"setFocusByFirstCharacter",value:function(e,t){var s,i;t.length>1||(t=t.toLowerCase(),(s=this.menuitemNodes.indexOf(e)+1)>=this.menuitemNodes.length&&(s=0),-1===(i=this.firstChars.indexOf(t,s))&&(i=this.firstChars.indexOf(t,0)),i>-1&&this.setFocusToMenuitem(this.menuitemNodes[i]))}},{key:"getIndexFirstChars",value:function(e,t){for(var s=e;s<this.firstChars.length;s++)if(t===this.firstChars[s])return s;return-1}},{key:"openPopup",value:function(){this.menuNode.style.display="block",this.buttonNode.setAttribute("aria-expanded","true")}},{key:"closePopup",value:function(){this.isOpen()&&(this.buttonNode.setAttribute("aria-expanded","false"),this.menuNode.style.display="none")}},{key:"isOpen",value:function(){return"true"===this.buttonNode.getAttribute("aria-expanded")}},{key:"onFocusin",value:function(){this.domNode.classList.add("focus")}},{key:"onFocusout",value:function(){this.domNode.classList.remove("focus")}},{key:"onButtonKeydown",value:function(e){var t=!1;switch(e.key){case" ":case"Enter":case"ArrowDown":case"Down":this.openPopup(),this.setFocusToFirstMenuitem(),t=!0;break;case"Esc":case"Escape":this.closePopup(),this.buttonNode.focus(),t=!0;break;case"Up":case"ArrowUp":this.openPopup(),this.setFocusToLastMenuitem(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}},{key:"onButtonClick",value:function(e){this.isOpen()?(this.closePopup(),this.buttonNode.focus()):(this.openPopup(),this.setFocusToFirstMenuitem()),e.stopPropagation(),e.preventDefault()}},{key:"onMenuitemKeydown",value:function(e){var t=e.currentTarget,s=e.key,i=!1;function o(e){return 1===e.length&&e.match(/\S/)}if(!(e.ctrlKey||e.altKey||e.metaKey)){if(e.shiftKey)o(s)&&(this.setFocusByFirstCharacter(t,s),i=!0),"Tab"===e.key&&(this.buttonNode.focus(),this.closePopup(),i=!0);else switch(s){case"Enter":case" ":window.location.href=t.href;break;case"Esc":case"Escape":this.closePopup(),this.buttonNode.focus(),i=!0;break;case"Up":case"ArrowUp":this.setFocusToPreviousMenuitem(t),i=!0;break;case"ArrowDown":case"Down":this.setFocusToNextMenuitem(t),i=!0;break;case"Home":case"PageUp":this.setFocusToFirstMenuitem(),i=!0;break;case"End":case"PageDown":this.setFocusToLastMenuitem(),i=!0;break;case"Tab":this.closePopup();break;default:o(s)&&(this.setFocusByFirstCharacter(t,s),i=!0)}i&&(e.stopPropagation(),e.preventDefault())}}},{key:"onMenuitemMouseover",value:function(e){e.currentTarget.focus()}},{key:"onBackgroundMousedown",value:function(e){this.domNode.contains(e.target)||this.isOpen()&&(this.closePopup(),this.buttonNode.focus())}}]),e}();window.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".menu-button-links");for(let t=0;t<e.length;t++)new MenuButtonLinks(e[t])});